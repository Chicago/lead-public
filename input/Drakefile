import_shapefile()
	BASENAME=$(echo $INPUT | sed 's/.shp//') 
	# get table name from output, e.g. change $BASE/psql/input/wards gives input.wards
	TABLENAME=$(echo $OUTPUT | sed 's/.*psql\///;s/\//./') 
	# ogr2ogr doesn't like an existing file
	rm -f "$BASENAME"4326.*
	ogr2ogr -t_srs EPSG:4326 "$BASENAME"4326.shp $INPUT
	# -q suppresses query output which for large shapefiles seems to slow down the import
	shp2pgsql -I -D -d -s 4326 "$BASENAME"4326.shp $TABLENAME | psql -q
	touch $OUTPUT

wget_unzip()
    mkdir -p $(dirname $OUTPUT)
    wget --output-document=$(dirname $OUTPUT)/download.zip "$URL"
    unzip -o $(dirname $OUTPUT)/download.zip -d $(dirname $OUTPUT)

URL="https://data.cityofchicago.org/api/geospatial/sp34-6z76?method=export&format=Shapefile"
data/shapefiles/wards/WARDS_2015.shp <- [-timecheck method:wget_unzip]
psql/input/wards <- data/shapefiles/wards/WARDS_2015.shp [method:import_shapefile]

URL="https://data.cityofchicago.org/api/geospatial/5jrd-6zik?method=export&format=Shapefile"
data/shapefiles/census_tracts/CensusTractsTIGER2010.shp <- [-timecheck method:wget_unzip]
psql/input/census_tracts <- data/shapefiles/census_tracts/CensusTractsTIGER2010.shp [method:import_shapefile]
	
URL="https://datacatalog.cookcountyil.gov/api/geospatial/jev2-4wjs?method=export&format=Shapefile"
data/shapefiles/addresses/addressPointChi.shp <- [-timecheck method:wget_unzip]
psql/input/addresses <- data/shapefiles/addresses/addressPointChi.shp [method:import_shapefile]

URL="https://data.cityofchicago.org/api/geospatial/cauq-8yn6?method=export&format=Shapefile"
data/shapefiles/community_areas/CommAreas.shp <- [-timecheck method:wget_unzip]
psql/input/community_areas <- data/shapefiles/community_areas/CommAreas.shp [method:import_shapefile]

psql/input/assessor <- input/assessor.sh
    $INPUT $ASSESSOR_FILE

;psql/input/tests <- input/tests.sh
;	$[INPUT] && touch $[OUTPUT]
	
psql/input/currbllshort <- input/currbllshort.sh
	# psql \copy doesn't like "" as null for non-text
	# currbllshort has duplicates, use uniq
	sed 's/""//g' $CURRBLLSHORT_FILE | uniq | $INPUT && touch $OUTPUT
	
psql/input/inspections <- input/inspections.sh
	$INPUT $INSPECTIONS_FILE && touch $OUTPUT

; documentation: http://www2.census.gov/topics/genealogy/2000surnames/surnames.pdf
data/surnames/names.zip <- [-timecheck]
	mkdir -p `dirname $OUTPUT`
	wget -O $OUTPUT http://www2.census.gov/topics/genealogy/2000surnames/names.zip

data/surnames/app_c.csv <- data/surnames/names.zip
	unzip -o $INPUT -d `dirname $OUTPUT` && touch $OUTPUT # update timestamp

; remove suprressed values
data/surnames/surnames.csv <- data/surnames/app_c.csv
     cat $INPUT | sed 's/(S)//g' > $OUTPUT

psql/input/surnames <- input/surnames.sql, data/surnames/surnames.csv [method:psql]

; download, unzip, and import buildings data
data/shapefiles/buildings/data/Buildings.zip <- [-timecheck]
    git clone https://github.com/Chicago/osd-building-footprints $(dirname $OUTPUT)/..
data/shapefiles/buildings/data/Buildings.json <- data/shapefiles/buildings/data/Buildings.zip
    unzip $INPUT -d $(dirname $OUTPUT)
psql/input/buildings <- input/buildings.sh, data/shapefiles/buildings/data/Buildings.json
    $INPUT $INPUT1 && touch $OUTPUT

wget_acs()
    mkdir -p $(dirname $OUTPUT)
    cd $(dirname $OUTPUT)
    z=$((year-4)) 
    URL="http://www2.census.gov/acs"$year"_5yr/summaryfile/"$z"-"$year"_ACSSF_By_State_All_Tables/Illinois_Tracts_Block_Groups_Only.zip"
    wget $URL

%include acs_profile
$(for y in {2009..2013}; do

echo "year=$y"
echo "data/acssf/acs"$y"_5yr/Illinois_Tracts_Block_Groups_Only.zip <- [-timecheck method:wget_acs]"

echo "data/acssf/acs"$y"_5yr/data/ <- data/acssf/acs"$y"_5yr/Illinois_Tracts_Block_Groups_Only.zip [-timecheck]"
echo "    unzip \$INPUT -d \$OUTPUT"

echo "input/acs/generated/acs"$y"_5yr/import.sql <- data/census-postgres/acs"$y"_5yr/, data/acssf/acs"$y"_5yr/data/, input/acs/census_postgres.sh"
echo "    input/acs/census_postgres.sh \$INPUT0 \$INPUT1 input/acs/generated/acs"$y"_5yr/"

echo "psql/acs"$y"_5yr <- input/acs/generated/acs"$y"_5yr/import.sql [method:psql]"

done)
%include $[PROFILE]
